<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Debug - Sherlock Holmes Edition</title>
    <style>
        body {
            font-family: monospace;
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        h1 { color: #ffff00; border-bottom: 2px solid #ffff00; padding-bottom: 10px; }
        h2 { color: #00ffff; margin-top: 30px; }
        .section {
            background: #2a2a2a;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #00ff00;
            border-radius: 5px;
        }
        .error { color: #ff0000; font-weight: bold; }
        .success { color: #00ff00; font-weight: bold; }
        .warning { color: #ffaa00; }
        #qrCanvas {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border: 3px solid #00ff00;
        }
        pre {
            background: #0a0a0a;
            padding: 10px;
            overflow-x: auto;
            border: 1px solid #333;
        }
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover { background: #00cc00; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
</head>
<body>
    <h1>üîç SHERLOCK HOLMES QR CODE INVESTIGATION</h1>

    <div class="section">
        <h2>üìã STEP 1: Fetch QR Code from API</h2>
        <div id="step1">‚è≥ Fetching...</div>
    </div>

    <div class="section">
        <h2>üìä STEP 2: API Response Analysis</h2>
        <div id="step2"></div>
    </div>

    <div class="section">
        <h2>üé® STEP 3: Canvas Rendering Test</h2>
        <canvas id="qrCanvas"></canvas>
        <div id="step3"></div>
    </div>

    <div class="section">
        <h2>üìù STEP 4: Raw QR Code String</h2>
        <pre id="rawQR" style="word-wrap: break-word; white-space: pre-wrap;">‚è≥ Loading...</pre>
    </div>

    <div class="section">
        <h2>üß™ STEP 5: QRCode Library Test</h2>
        <div id="step5"></div>
    </div>

    <div class="section">
        <h2>üîÑ Actions</h2>
        <button onclick="runFullDiagnostic()">üîç Run Full Diagnostic</button>
        <button onclick="testSimpleQR()">üß™ Test Simple QR</button>
        <button onclick="location.reload()">‚ôªÔ∏è Reload Page</button>
    </div>

    <div class="section">
        <h2>üìú Console Logs</h2>
        <pre id="logs"></pre>
    </div>

    <script>
        let logs = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            logs.push(logEntry);
            console.log(logEntry);
            document.getElementById('logs').textContent = logs.join('\n');
        }

        async function runFullDiagnostic() {
            log('üîç Starting Sherlock Holmes Investigation...', 'info');

            // Step 1: Fetch API
            try {
                log('üì° Fetching /api/qr-debug...', 'info');
                const response = await fetch('/api/qr-debug');

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                log('‚úÖ API Response received', 'success');

                document.getElementById('step1').innerHTML = `
                    <span class="success">‚úÖ API Fetch SUCCESS</span><br>
                    Status: ${response.status} ${response.statusText}<br>
                    Response Time: ${Date.now()} ms
                `;

                // Step 2: Analyze response
                document.getElementById('step2').innerHTML = `
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                    <br>
                    <strong>Analysis:</strong><br>
                    ‚Ä¢ hasQRCode: ${data.hasQRCode ? '<span class="success">‚úÖ YES</span>' : '<span class="error">‚ùå NO</span>'}<br>
                    ‚Ä¢ qrCode exists: ${data.qrCode ? '<span class="success">‚úÖ YES</span>' : '<span class="error">‚ùå NO</span>'}<br>
                    ‚Ä¢ qrCodeLength: ${data.qrCodeLength} characters<br>
                    ‚Ä¢ isConnected: ${data.isConnected ? '<span class="success">‚úÖ YES</span>' : '<span class="warning">‚è≥ NO</span>'}<br>
                    ‚Ä¢ Timestamp: ${data.timestamp}
                `;

                // Step 4: Show raw QR
                if (data.qrCode) {
                    document.getElementById('rawQR').textContent = data.qrCode;
                    log(`üìù QR Code string: ${data.qrCode.substring(0, 50)}...`, 'info');
                } else {
                    document.getElementById('rawQR').innerHTML = '<span class="error">‚ùå NO QR CODE IN RESPONSE</span>';
                    log('‚ùå No QR code in API response', 'error');
                    return;
                }

                // Step 3: Render Canvas
                try {
                    log('üé® Attempting to render QR Code to canvas...', 'info');

                    const canvas = document.getElementById('qrCanvas');

                    await QRCode.toCanvas(canvas, data.qrCode, {
                        width: 400,
                        margin: 2,
                        color: {
                            dark: '#000000',
                            light: '#ffffff'
                        }
                    });

                    log('‚úÖ QR Code rendered successfully!', 'success');
                    document.getElementById('step3').innerHTML = `
                        <span class="success">‚úÖ QR CODE RENDERED SUCCESSFULLY!</span><br>
                        Canvas Width: ${canvas.width}px<br>
                        Canvas Height: ${canvas.height}px<br>
                        <strong>üëÜ YOU SHOULD SEE THE QR CODE ABOVE üëÜ</strong>
                    `;

                } catch (renderError) {
                    log(`‚ùå Canvas render failed: ${renderError.message}`, 'error');
                    document.getElementById('step3').innerHTML = `
                        <span class="error">‚ùå CANVAS RENDER FAILED</span><br>
                        Error: ${renderError.message}<br>
                        Stack: <pre>${renderError.stack}</pre>
                    `;
                }

                // Step 5: Test QRCode library
                document.getElementById('step5').innerHTML = `
                    <strong>QRCode Library Status:</strong><br>
                    ‚Ä¢ Loaded: ${typeof QRCode !== 'undefined' ? '<span class="success">‚úÖ YES</span>' : '<span class="error">‚ùå NO</span>'}<br>
                    ‚Ä¢ Version: ${QRCode.version || 'Unknown'}<br>
                    ‚Ä¢ toCanvas method: ${typeof QRCode.toCanvas === 'function' ? '<span class="success">‚úÖ Available</span>' : '<span class="error">‚ùå Missing</span>'}
                `;

            } catch (error) {
                log(`‚ùå FATAL ERROR: ${error.message}`, 'error');
                document.getElementById('step1').innerHTML = `
                    <span class="error">‚ùå API FETCH FAILED</span><br>
                    Error: ${error.message}<br>
                    <pre>${error.stack}</pre>
                `;
            }
        }

        function testSimpleQR() {
            log('üß™ Testing simple QR code generation...', 'info');
            try {
                const canvas = document.getElementById('qrCanvas');
                QRCode.toCanvas(canvas, 'https://www.google.com', {
                    width: 300
                });
                log('‚úÖ Simple QR test SUCCESS', 'success');
                alert('‚úÖ Simple QR Code rendered! If you see it, the library works.');
            } catch (error) {
                log(`‚ùå Simple QR test FAILED: ${error.message}`, 'error');
                alert('‚ùå QR Library is broken: ' + error.message);
            }
        }

        // Auto-run on load
        window.addEventListener('load', () => {
            log('üöÄ Page loaded, starting diagnostic...', 'info');
            runFullDiagnostic();
        });

        // Catch all errors
        window.addEventListener('error', (e) => {
            log(`‚ùå Global error: ${e.message}`, 'error');
        });
    </script>
</body>
</html>
